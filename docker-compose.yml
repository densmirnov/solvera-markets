services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - SUBGRAPH_URL=${SUBGRAPH_URL:-https://api.studio.thegraph.com/query/17884/solvera/version/latest}
      - SUBGRAPH_CACHE_TTL_MS=${SUBGRAPH_CACHE_TTL_MS:-5000}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-120}
      - CORS_ORIGIN=${CORS_ORIGIN:-*}
      - CONTRACT_ADDRESS=${CONTRACT_ADDRESS:-0x0000000000000000000000000000000000000001}
      - NETWORK_NAME=${NETWORK_NAME:-base}
      - CHAIN_ID=${CHAIN_ID:-8453}
      - FEE_BPS_ON_ACCEPT=${FEE_BPS_ON_ACCEPT:-50}
      - FIXED_FEE_ON_EXPIRE=${FIXED_FEE_ON_EXPIRE:-1000000}
      - BOND_BPS_OF_REWARD=${BOND_BPS_OF_REWARD:-500}
      - BOND_MIN=${BOND_MIN:-1000000}
      - PORT=3000
    expose:
      - "3000"
    restart: unless-stopped

  indexer:
    build:
      context: ./indexer
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
    command: ["/bin/sh", "-c", "npm run build"]
    restart: "no"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-http://localhost:3000/api}
    expose:
      - "80"
    depends_on:
      - backend
    restart: unless-stopped

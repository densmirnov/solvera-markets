services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - SUBGRAPH_URL=${SUBGRAPH_URL}
      - SUBGRAPH_CACHE_TTL_MS=${SUBGRAPH_CACHE_TTL_MS:-5000}
      - RATE_LIMIT_WINDOW_MS=${RATE_LIMIT_WINDOW_MS:-60000}
      - RATE_LIMIT_MAX=${RATE_LIMIT_MAX:-120}
      - PORT=3000
    ports:
      - "3000:3000"
    restart: unless-stopped

  indexer:
    build:
      context: ./indexer
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=production
    command: ["/bin/sh", "-c", "npm run build"]
    restart: "no"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: ${VITE_API_BASE:-http://localhost:3000/api}
    ports:
      - "4173:80"
    depends_on:
      - backend
    restart: unless-stopped
